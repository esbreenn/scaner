<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Escáner EAN-13 con Stock Dinámico</title>
  <style>
    #result button { margin: 0 5px; padding: 4px 8px; }
  </style>
</head>
<body>
  <h2>Escáner de Código de Barras (EAN-13)</h2>
  <div id="scanner-container"></div>
  <div id="result"></div>

  <!-- Formulario para nuevos productos -->
  <div id="form-container" style="display:none;">
    <h3>Agregar producto</h3>
    <form id="add-product-form">
      <input type="text"    id="product-name"  placeholder="Nombre del producto" required><br>
      <input type="number"  id="product-price" placeholder="Precio"          required><br>
      <input type="number"  id="product-stock" placeholder="Stock inicial"   required><br>
      <button type="submit">Guardar producto</button>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    // (1) Ejemplo reducido de stock
    const listado = {
      "4006381333931": { nombre: "Café Nescafé", precio: 1200, stock: 5 },
      "5011417933000": { nombre: "Aceite de Oliva", precio: 3500, stock: 3 },
      // …otros…
    };

    let ultimoCodigo = null;

    // (2) Función para mostrar producto o formulario
    function mostrarProducto(code) {
      const resultDiv = document.getElementById("result");
      const formCont  = document.getElementById("form-container");

      if (!listado[code]) {
        resultDiv.innerHTML = `<strong>Código no encontrado:</strong> ${code}`;
        formCont.style.display = "block";
        return;
      }

      formCont.style.display = "none";
      const p = listado[code];
      resultDiv.innerHTML = `
        <p><strong>Producto:</strong> ${p.nombre}</p>
        <p><strong>Precio:</strong> $${p.precio}</p>
        <p><strong>Stock:</strong> ${p.stock}</p>
        <button data-action="decrease">−</button>
        <button data-action="increase">＋</button>
        <button data-action="delete">Eliminar</button>
      `;
    }

    // (3) Eventos de los botones de stock / eliminar
    document.getElementById("result").addEventListener("click", e => {
      if (!ultimoCodigo) return;
      const action = e.target.getAttribute("data-action");
      const prod   = listado[ultimoCodigo];
      if (!action || !prod) return;

      if (action === "increase")      prod.stock++;
      else if (action === "decrease" && prod.stock > 0) prod.stock--;
      else if (action === "delete") {
        delete listado[ultimoCodigo];
        ultimoCodigo = null;
        document.getElementById("result").innerHTML = `<em>Producto eliminado.</em>`;
        return;
      }

      mostrarProducto(ultimoCodigo);
    });

    // (4) Formulario para agregar nuevo producto
    document.getElementById("add-product-form").addEventListener("submit", e => {
      e.preventDefault();
      const name  = document.getElementById("product-name").value.trim();
      const price = parseFloat(document.getElementById("product-price").value);
      const stock = parseInt(document.getElementById("product-stock").value, 10);

      if (name && !isNaN(price) && !isNaN(stock) && ultimoCodigo) {
        listado[ultimoCodigo] = { nombre: name, precio: price, stock };
        mostrarProducto(ultimoCodigo);
        e.target.reset();
      }
    });

    // (5) Inicialización de Quagga
    function startScanner() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector("#scanner-container"),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader"] }
      }, err => {
        if (err) { console.error(err); return; }
        Quagga.start();
      });

      Quagga.onDetected(data => {
        const code = data.codeResult.code;
        if (code !== ultimoCodigo) {
          ultimoCodigo = code;
          mostrarProducto(code);
        }
      });
    }

    window.addEventListener("load", startScanner);
  </script>
</body>
</html>
