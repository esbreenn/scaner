<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Scanner EAN-13 nativo & Firebase</title>
  <style>
    body { font-family:sans-serif; text-align:center; padding:1rem; background:#f0f2f5; }
    #video { width:100%; max-width:360px; border:2px dashed #666; border-radius:8px; }
    #result, #form { max-width:360px; margin:1rem auto; background:#fff; padding:1rem; border-radius:8px;
                     box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:left; }
    #form { display:none; }
    input, button { width:100%; padding:0.5rem; margin:0.5rem 0; border-radius:4px; border:1px solid #ccc; }
    button { background:#007bff; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>
  <h2>Escáner EAN-13 nativo & Firebase</h2>

  <video id="video" autoplay playsinline></video>

  <div id="result"></div>

  <div id="form">
    <h3>Agregar producto</h3>
    <input id="name"  type="text"   placeholder="Nombre del producto" required/>
    <input id="price" type="number" placeholder="Precio"          required/>
    <input id="stock" type="number" placeholder="Stock inicial"   required/>
    <button id="save">Guardar</button>
  </div>

  <!-- Firebase UMD -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  <script>
    // firebase.js inlined
    const cfg = {
      apiKey: "AIzaSyBtbiJpjiVsfhUVmnF23huJLyYOw5tikB0",
      authDomain: "scanner-prueba-f3ae0.firebaseapp.com",
      projectId: "scanner-prueba-f3ae0",
      storageBucket: "scanner-prueba-f3ae0.appspot.com",
      messagingSenderId: "578819836928",
      appId: "1:578819836928:web:f496190221317d372fdce5"
    };
    firebase.initializeApp(cfg);
    window.db = firebase.firestore();

    // CRUD
    async function fetchProduct(code) {
      const snap = await db.collection('productos').doc(code).get();
      return snap.exists ? snap.data() : null;
    }
    async function saveProduct(code, data) {
      await db.collection('productos').doc(code).set(data);
    }
    async function deleteProduct(code) {
      await db.collection('productos').doc(code).delete();
    }

    // UI
    const video  = document.getElementById('video');
    const resDiv = document.getElementById('result');
    const form   = document.getElementById('form');
    let lastCode = null, currentCode = null;

    function showProduct(code, p) {
      if (!p) {
        resDiv.innerHTML = `<strong>No existe:</strong> ${code}`;
        form.style.display = 'block';
        currentCode = code;
      } else {
        form.style.display = 'none';
        resDiv.innerHTML = `
          <p><strong>${p.nombre}</strong></p>
          <p>Precio: $${p.precio} | Stock: ${p.stock}</p>
          <button id="inc">＋</button>
          <button id="dec">−</button>
          <button id="del">Eliminar</button>
        `;
        document.getElementById('inc').onclick = async () => {
          p.stock++; await saveProduct(code,p); showProduct(code,p);
        };
        document.getElementById('dec').onclick = async () => {
          p.stock = Math.max(0,p.stock-1);
          await saveProduct(code,p); showProduct(code,p);
        };
        document.getElementById('del').onclick = async () => {
          await deleteProduct(code);
          lastCode = null;
          resDiv.innerHTML = '<em>Eliminado.</em>';
        };
      }
    }

    document.getElementById('save').onclick = async () => {
      if (!currentCode) return;
      const data = {
        nombre: document.getElementById('name').value.trim(),
        precio: parseFloat(document.getElementById('price').value),
        stock:  parseInt(document.getElementById('stock').value,10)
      };
      await saveProduct(currentCode,data);
      showProduct(currentCode,data);
      form.reset();
    };

    // Cámara
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
        video.srcObject = stream;
      } catch(e) {
        resDiv.innerText = 'Error cámara: ' + e;
      }
    }

    // Escaneo con BarcodeDetector
    async function scanLoop() {
      if (!('BarcodeDetector' in window)) {
        resDiv.innerText = 'Este navegador no soporta BarcodeDetector.';
        return;
      }
      const detector = new BarcodeDetector({ formats:['ean_13'] });
      setInterval(async () => {
        try {
          const codes = await detector.detect(video);
          if (codes.length) {
            const code = codes[0].rawValue;
            if (code !== lastCode && code.length===13) {
              lastCode = code;
              const p = await fetchProduct(code);
              showProduct(code,p);
            }
          }
        } catch(e){}
      }, 500);
    }

    // Arranque
    startCamera().then(scanLoop);
  </script>
</body>
</html>
