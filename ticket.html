<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Ticket de Venta</title>
  <link rel="stylesheet" href="ticket.css">
</head>
<body>
  <div id="ticket">
    <!-- Se va rellenando por JavaScript -->
  </div>
  <button id="print-btn">ðŸ–¨ Imprimir</button>

  <!-- Firebase UMD -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  <script src="./firebase.js"></script>

  <script>
    // 1) Extraer saleId de la URL
    const params = new URLSearchParams(location.search);
    const saleId = params.get('saleId');
    const ticketDiv = document.getElementById('ticket');

    // 2) Plantilla bÃ¡sica
    function renderTicket(data) {
      const d = new Date(data.timestamp.toDate());
      let html = `
        <h2>Mi Tienda S.A.</h2>
        <p>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</p>
        <hr>
        <table>
          <thead><tr>
            <th>CÃ³digo</th><th>ArtÃ­Â­culo</th><th>Cant.</th><th>Precio</th>
          </tr></thead>
          <tbody>
      `;
      data.items.forEach(i => {
        html += `
          <tr>
            <td>${i.code}</td>
            <td>${i.nombre}</td>
            <td>${i.cantidad}</td>
            <td>$${(i.precio*i.cantidad).toFixed(2)}</td>
          </tr>
        `;
      });
      html += `
          </tbody>
        </table>
        <hr>
        <h3>Total: $${data.total.toFixed(2)}</h3>
        <p>Â¡Gracias por su compra!</p>
      `;
      ticketDiv.innerHTML = html;
    }

    // 3) Cargar de Firestore
    window.db.collection('ventas').doc(saleId).get()
      .then(doc => {
        if (!doc.exists) throw new Error('Venta no encontrada');
        renderTicket(doc.data());
      })
      .catch(err => {
        ticketDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      });

    // 4) BotÃ³n imprimir
    document.getElementById('print-btn').onclick = () => window.print();
  </script>
</body>
</html>
